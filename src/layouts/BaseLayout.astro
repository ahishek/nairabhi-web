---
import '../styles/global.css';
import '../styles/agent-mode.css';

interface Props {
  title: string;
  description?: string;
}

const { title, description = "Abhishek Nair â€” Product Manager, Engineer, Builder" } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <title>{title} | nairabhi.com</title>
  </head>
  <body class="scanlines" data-view="human">
    <script is:inline>
      (() => {
        const STORAGE_KEY = 'site-view-mode';
        const MODE_PARAM_KEY = 'view';
        const MACHINE_CLASS = 'machine-mode';
        const EVENT_NAME = 'view-mode-change';

        const isValidMode = (value) => value === 'human' || value === 'machine';

        const getInitialMode = () => {
          const params = new URLSearchParams(window.location.search);
          const modeFromUrl = params.get(MODE_PARAM_KEY);
          if (isValidMode(modeFromUrl)) return modeFromUrl;

          const savedMode = localStorage.getItem(STORAGE_KEY);
          if (isValidMode(savedMode)) return savedMode;

          return 'human';
        };

        const applyModeToDom = (mode) => {
          document.body.dataset.view = mode;
          document.body.classList.toggle(MACHINE_CLASS, mode === 'machine');
        };

        const listeners = new Set();
        let currentMode = getInitialMode();

        const setMode = (nextMode) => {
          if (!isValidMode(nextMode) || nextMode === currentMode) return;
          currentMode = nextMode;
          localStorage.setItem(STORAGE_KEY, nextMode);
          applyModeToDom(nextMode);
          listeners.forEach((listener) => listener(nextMode));
          document.dispatchEvent(new CustomEvent(EVENT_NAME, { detail: { mode: nextMode } }));
        };

        applyModeToDom(currentMode);

        window.__viewModeStore = {
          getMode: () => currentMode,
          setMode,
          subscribe: (listener) => {
            listeners.add(listener);
            return () => listeners.delete(listener);
          },
        };
      })();
    </script>

    <div class="agent-meta" aria-hidden="true">
      &lt;!-- You found the machine-readable version. Respect. --&gt;
    </div>

    <slot name="header" />

    <main>
      <slot />
    </main>

    <slot name="footer" />
  </body>
</html>
