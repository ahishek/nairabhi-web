---
import '../styles/global.css';
import '../styles/agent-mode.css';

interface Props {
  title: string;
  description?: string;
}

const { title, description = "Abhishek Nair â€” Product Manager, Engineer, Builder" } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <title>{title} | nairabhi.com</title>
  </head>
  <body class="scanlines">
    <div class="layout-shell">
      <div class="agent-meta" aria-hidden="true">
        &lt;!-- You found the machine-readable version. Respect. --&gt;
      </div>

      <div class="layout-group layout-header">
        <slot name="header" />
      </div>

      <main class="layout-group layout-main">
        <slot />
      </main>

      <div class="layout-group layout-footer">
        <slot name="footer" />
      </div>
    </div>

    <script>
      const TRANSITION_MS = 240;
      const PHASE_A_MS = 110;

      const body = document.body;
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)');
      let phaseATimer: number | undefined;
      let cleanupTimer: number | undefined;

      const applyMode = (mode: 'human' | 'agent') => {
        if (mode === 'agent') {
          body.classList.add('agent-mode');
          return;
        }
        body.classList.remove('agent-mode');
      };

      const transitionToMode = (mode: 'human' | 'agent') => {
        const currentMode = body.classList.contains('agent-mode') ? 'agent' : 'human';

        if (currentMode === mode) {
          localStorage.setItem('view-mode', mode);
          return;
        }

        if (prefersReducedMotion.matches) {
          applyMode(mode);
          localStorage.setItem('view-mode', mode);
          return;
        }

        if (phaseATimer) {
          window.clearTimeout(phaseATimer);
        }

        if (cleanupTimer) {
          window.clearTimeout(cleanupTimer);
        }

        body.dataset.transitioning = 'phase-a';
        body.dataset.transitionTarget = mode;

        phaseATimer = window.setTimeout(() => {
          applyMode(mode);
          body.dataset.transitioning = 'phase-b';
        }, PHASE_A_MS);

        cleanupTimer = window.setTimeout(() => {
          delete body.dataset.transitioning;
          delete body.dataset.transitionTarget;
        }, TRANSITION_MS);

        localStorage.setItem('view-mode', mode);
      };

      // Restore view mode from localStorage
      const savedMode = localStorage.getItem('view-mode');
      if (savedMode === 'agent') {
        applyMode('agent');
      }

      // Listen for toggle events
      document.addEventListener('view-mode-change', (e: Event) => {
        const customEvent = e as CustomEvent;
        const mode = customEvent.detail.mode as 'human' | 'agent';
        transitionToMode(mode);
      });
    </script>

    <style is:global>
      body[data-transitioning] .layout-main,
      body[data-transitioning] .layout-header,
      body[data-transitioning] .layout-footer,
      body[data-transitioning] .layout-footer .toggle-section {
        will-change: opacity, transform;
      }

      body[data-transitioning='phase-a'] .layout-main,
      body[data-transitioning='phase-a'] .layout-header,
      body[data-transitioning='phase-a'] .layout-footer,
      body[data-transitioning='phase-a'] .layout-footer .toggle-section {
        opacity: 0.42;
        transform: translateY(5px);
        transition: opacity 110ms ease, transform 110ms ease;
      }

      body[data-transitioning='phase-b'] .layout-main,
      body[data-transitioning='phase-b'] .layout-header,
      body[data-transitioning='phase-b'] .layout-footer,
      body[data-transitioning='phase-b'] .layout-footer .toggle-section {
        opacity: 1;
        transform: translateY(0);
        transition: opacity 130ms ease, transform 130ms ease;
      }

      @media (prefers-reduced-motion: reduce) {
        body[data-transitioning] .layout-main,
        body[data-transitioning] .layout-header,
        body[data-transitioning] .layout-footer,
        body[data-transitioning] .layout-footer .toggle-section {
          transition: none !important;
          transform: none !important;
          opacity: 1 !important;
        }
      }
    </style>
  </body>
</html>
